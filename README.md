# Cервис для асинхронной обработки задач с возможностью масштабирования и отказоустойчивости
## Общее описание

Сервис управления задачами представляет собой распределённую систему, включающую:

- Веб-сервер (FastAPI), предоставляющий REST API для создания, получения и удаления задач

- Очередь сообщений (RabbitMQ), обеспечивающую асинхронную обработку задач

- Воркера, считывающего задачи из очереди и выполняющего их с сохранением результата в базу данных (PostgreSQL)

### Сервис позволяет:
- Создавать задачи через HTTP API 
- Обрабатывать задачи в фоновом режиме с учетом приоритета
- Хранить статус и результат выполнения задач
- Обрабатывать ошибки выполнения и сохранять информацию о сбоях

## Установка и запуск
### Сборка и запуск через Docker Compose
```bash
docker-compose up --build
```
## Работа с API
Документация доступна по адресу _host:8000/docs_

```DELETE /api/v1/tasks/{task_id}``` - Удаление из RabbitMQ невозможно, если задача уже доставлена воркеру

## RabbitMQ: Очередь с приоритетом

Очередь TASKS_QUEUE:

Сообщения отправляются с полем priority, влияющим на порядок обработки.

## Worker: обработка задач

Воркеры подключаются к RabbitMQ, читают сообщения и:
- Получают задачу по ID из БД
- Обновляют статус: in_progress 
- Выполняют задачу (эмуляция: asyncio.sleep)
- Обновляют статус: completed + сохраняют результат 
- При ошибке: failed + текст ошибки

Поведение при сбоях:
- Если RabbitMQ отключен, задачи сохраняются в БД, но не отправляются 
- При восстановлении соединения — отправляются только новые задачи
- Отдельный механизм (в будущем) может отправлять старые неподтверждённые задачи


## Обработка ошибок и отказоустойчивость
- При недоступности RabbitMQ — сообщение не публикуется, задача сохраняется
- При сбое во время обработки — задача помечается как failed
- Используется try/except с логированием для каждого этапа
- Возможность доработки: повторная отправка «зависших» задач

## Журналирование

- Используется logging 
- Логи пишутся в stdout (видны в Docker)

Примеры:
- Получена задача
- Ошибка обработки задачи
- RabbitMQ не отвечает

## Тестирование

1. Поднять окружение

```bash
docker compose -f src/tests/integration/docker-compose.test.yml up -d
```

2. Запустить тесты
```bash
pytest .
```
## Возможные улучшения

- Реализация повторной отправки задач при восстановлении RabbitMQ 
- Обработка отмены задачи, если она уже попала воркеру 
- Поддержка retries с backoff
- Автоудаление старых задач
